<!DOCTYPE html>
<html lang="en">

<head>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T3W696WJ1K"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-T3W696WJ1K');
</script>


<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<meta name="HandheldFriendly" content="True" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<meta property="og:image" content="https://masatakashiwagi.github.io/portfolio/favicon/mstile-150x150.png?raw=true">
<meta name="generator" content="Hugo 0.111.3">


<meta name="google-site-verification" content="8AFoblWp77w-X0y6tUFrOqd4miPkLbiFNBz7acmmMho" />




<link rel="apple-touch-icon" sizes="180x180" href="https://masatakashiwagi.github.io/portfolio/favicon/apple-touch-icon.png" />
<link rel="icon" type="image/png" sizes="32x32" href="https://masatakashiwagi.github.io/portfolio/favicon/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="https://masatakashiwagi.github.io/portfolio/favicon/favicon-16x16.png" />
<link rel="manifest" href="https://masatakashiwagi.github.io/portfolio/favicon/site.webmanifest" />
<link rel="mask-icon" href="https://masatakashiwagi.github.io/portfolio/favicon/safari-pinned-tab.svg" color="#5bbad5" />
<link rel="shortcut icon" href="https://masatakashiwagi.github.io/portfolio/favicon/favicon.ico" />
<meta name="msapplication-TileColor" content="#da532c" />
<meta name="theme-color" content="#ffffff" />


<title>FastAPI ã¨ RabbitMQ ã‚’ç”¨ã„ãŸæ©Ÿæ¢°å­¦ç¿’ã‚¿ã‚¹ã‚¯ã®éåŒæœŸå‡¦ç† - Fractal Prologue</title>


<meta name="author" content="Masataka Kashiwagi" />


<meta name="description" content="FastAPI ã¨ RabbitMQ ã‚’ç”¨ã„ã¦æ©Ÿæ¢°å­¦ç¿’ã®ãƒ¢ãƒ‡ãƒ«å­¦ç¿’å‡¦ç†ã‚’éåŒæœŸåŒ–ã™ã‚‹è©±ã‚’æ›¸ãã¾ã—ãŸ" />


<meta name="keywords" content="DEV, ML" />

<meta property="og:title" content="FastAPI ã¨ RabbitMQ ã‚’ç”¨ã„ãŸæ©Ÿæ¢°å­¦ç¿’ã‚¿ã‚¹ã‚¯ã®éåŒæœŸå‡¦ç†" />
<meta property="og:description" content="FastAPI ã¨ RabbitMQ ã‚’ç”¨ã„ã¦æ©Ÿæ¢°å­¦ç¿’ã®ãƒ¢ãƒ‡ãƒ«å­¦ç¿’å‡¦ç†ã‚’éåŒæœŸåŒ–ã™ã‚‹è©±ã‚’æ›¸ãã¾ã—ãŸ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://masatakashiwagi.github.io/portfolio/post/async-ml-processing/" /><meta property="og:image" content="https://masatakashiwagi.github.io/portfolio/img/avatar.png"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-24T02:10:25+09:00" />
<meta property="article:modified_time" content="2022-04-24T02:10:25+09:00" /><meta property="og:site_name" content="Fractal Prologue" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://masatakashiwagi.github.io/portfolio/img/avatar.png"/>

<meta name="twitter:title" content="FastAPI ã¨ RabbitMQ ã‚’ç”¨ã„ãŸæ©Ÿæ¢°å­¦ç¿’ã‚¿ã‚¹ã‚¯ã®éåŒæœŸå‡¦ç†"/>
<meta name="twitter:description" content="FastAPI ã¨ RabbitMQ ã‚’ç”¨ã„ã¦æ©Ÿæ¢°å­¦ç¿’ã®ãƒ¢ãƒ‡ãƒ«å­¦ç¿’å‡¦ç†ã‚’éåŒæœŸåŒ–ã™ã‚‹è©±ã‚’æ›¸ãã¾ã—ãŸ"/>



<style>
    @media (prefers-color-scheme: dark) {
        body[data-theme='auto'] img {
            filter: brightness(60%);
        }
    }

    body[data-theme='dark'] img {
        filter: brightness(60%);
    }
</style>



<link rel="stylesheet" href="https://masatakashiwagi.github.io/portfolio/assets/css/fuji.min.css" />





<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'G-T3W696WJ1K');
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T3W696WJ1K"></script>


<script>
    window.ga_tid = 'G-T3W696WJ1K';
    window.ga_api = 'https:\/\/masatakashiwagi.github.io\/portfolio\/';
</script>
<script async src="https://cdn.jsdelivr.net/npm/cfga@1.0.3/cfga.min.js"></script>


<link rel="stylesheet" href="/portfolio/css/custom.css">
<link rel="shortcut icon" href="https://masatakashiwagi.github.io/portfolio/favicon/favicon-32x32.png">
<link rel="shortcut icon" href="https://masatakashiwagi.github.io/portfolio/favicon/favicon-16x16.png">
</head>

<body data-theme="auto">
    <script data-cfasync="false">
  
  var fujiThemeData = localStorage.getItem('fuji_data-theme');
  
  if (!fujiThemeData) {
    localStorage.setItem('fuji_data-theme', 'auto');
  } else {
    
    if (fujiThemeData !== 'auto') {
      document.body.setAttribute('data-theme', fujiThemeData === 'dark' ? 'dark' : 'light');
    }
  }
</script>

    <header>
    <div class="container-lg clearfix">
        <div class="col-12 header">
            <a class="title-main" href="https://masatakashiwagi.github.io/portfolio/">Fractal Prologue</a>
            
            <span class="title-sub">å¾’ç„¶ãªã‚‹ã¾ã¾ã«...ãƒ‡ãƒ¼ã‚¿ã¨éŠã¶</span>
            
        </div>
    </div>
</header>

    <main>
        <div class="container-lg clearfix">
            
            <div class="col-12 col-md-9 float-left content">
                
<article>
    
    <h2 class="post-item post-title">
        <a href="https://masatakashiwagi.github.io/portfolio/post/async-ml-processing/">FastAPI ã¨ RabbitMQ ã‚’ç”¨ã„ãŸæ©Ÿæ¢°å­¦ç¿’ã‚¿ã‚¹ã‚¯ã®éåŒæœŸå‡¦ç†</a>
    </h2>
    <div class="post-item post-meta">
        <span><i class="iconfont icon-today-sharp"></i>&nbsp;2022-04-24</span><span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;5431 words</span><span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href="/tags/dev">DEV</a>&nbsp;<a href="/tags/ml">ML</a>&nbsp;</span>

    </div>
    
    
    <div class="post-content markdown-body">
        <h2 id="ã¯ã˜ã‚ã«">ã¯ã˜ã‚ã«</h2>
<p>æœ€è¿‘ï¼Œæ©Ÿæ¢°å­¦ç¿’ã‚’ä½¿ã£ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã©ã†ã„ã£ãŸå‡¦ç†ã‚’è¡Œã£ã¦ãƒ¢ãƒ‡ãƒ«ä½œæˆãªã©ã‚’è¡Œã£ã¦ã„ã‚‹ã‹æ°—ã«ãªã£ãŸã®ã§ï¼Œãƒ¢ãƒ‡ãƒ«ä½œæˆæ™‚ã«ã‚ˆãè¡Œã‚ã‚Œã‚‹éåŒæœŸå‡¦ç†ã‚’ FastAPI ã¨ RabbitMQ ã‚’ç”¨ã„ã¦æ¤œè¨¼ã—ãŸãŠè©±ã«ãªã‚Šã¾ã™ï¼</p>
<p>æ©Ÿæ¢°å­¦ç¿’ã®ã‚ˆã†ãªãƒ¢ãƒ‡ãƒ«ä½œæˆã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆï¼Œãƒ¢ãƒ‡ãƒ«ä½œæˆã‚’è¡Œã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦ï¼Œãã®æƒ…å ±ã‚’å—ã‘å–ã£ãŸã¨ã„ã†ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã ã‘ã‚’å…ˆã«è¿”ã—ï¼Œå®Ÿéš›ã®å‡¦ç†ã¯éåŒæœŸã§è¡Œã‚ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã¨æ€ã„ã¾ã™ï¼ã“ã®å‡¦ç†ã‚’ RabbitMQ ã¨ã„ã† OSS ã® message queuing service ã‚’ç”¨ã„ã¦å®Ÿæ–½ã—ãŸç´¹ä»‹ã«ãªã‚Šã¾ã™ï¼</p>
<p>ã‚ã¨å€‹äººçš„ã« RPC (Remote Procedure Call) ã‚„ Publish/Subscribe ã®ä»•çµ„ã¿ã‚’ç†è§£ã—ãŸã„ã¨ã„ã†æ°—æŒã¡ã‚‚ã‚ã‚Šã¾ã—ãŸï¼</p>
<p>ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãªã©ã‚’ç½®ã„ã¦ã‚ã‚Šã¾ã™ï¼</p>
<iframe class="hatenablogcard" style="width:100%;height:155px;max-width:680px;" title="teamaya/async-processing at main Â· masatakashiwagi/teamaya" src="https://hatenablog-parts.com/embed?url=https://github.com/masatakashiwagi/teamaya/tree/main/async-processing" width="300" height="150" frameborder="0" scrolling="no"></iframe>
<p>æ¦‚è¦ã¨ã—ã¦ï¼Œä»¥ä¸‹ã®ã‚ˆã†ãªæµã‚Œã§å‡¦ç†ã‚’è¦‹ã¦ã„ãã¾ã—ãŸï¼</p>
<ol>
<li>FastAPI ã« json å½¢å¼ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ POST ã™ã‚‹ï¼ˆãƒ¢ãƒ‡ãƒ«ä½œæˆã™ã‚‹ãŸã‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æƒ…å ±ï¼‰</li>
<li><code>/train</code>ã¨ã„ã†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã¾ãšã¯ãƒ‡ãƒ¼ã‚¿ã‚’POSTã™ã‚‹</li>
<li>ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ãŒè¡Œã‚ã‚Œãƒ¢ãƒ‡ãƒ«ã‚’ S3 ã«ä¿å­˜ã™ã‚‹</li>
<li>ãƒ¢ãƒ‡ãƒ«ã®ä½œæˆãŒå®Œäº†ã—ãŸã‚‰ï¼Œæ¬¡ã«<code>/predict</code>ã¨ã„ã†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’POSTã™ã‚‹</li>
<li>å­¦ç¿’æ¸ˆã¿ã®ãƒ¢ãƒ‡ãƒ«ã‚’ S3 ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ï¼ŒPOST ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦äºˆæ¸¬ç¢ºç‡ã‚’è¿”ã™</li>
</ol>
<h2 id="message-queuing-serviceã¨ã¯">Message Queuing Serviceã¨ã¯ï¼Ÿ</h2>
<p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã¯ Producer ã¨å‘¼ã°ã‚Œã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒä½œæˆã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚Šï¼Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæºœã¾ã£ã¦ã„ãä»•çµ„ã¿ã§ã™ï¼Producer å´ã‹ã‚‰è¦‹ã‚‹ã¨ï¼Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é…ä¿¡ã—ã¾ã™ï¼ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã™ã‚‹å½¹å‰²ã¨ã—ã¦ï¼ŒConsumer (Worker) ã¨å‘¼ã°ã‚Œã‚‹åˆ¥ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šï¼ŒConsumer ã¯ Queue ã«æ¥ç¶šã—ï¼Œå‡¦ç†ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã¾ã™ï¼å‡¦ç†ã—çµ‚ã‚ã£ãŸã‚‰ï¼Œè¿”ä¿¡ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«é€ä¿¡ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼ï¼ˆQueue ã«å…¥ã‚Œã‚‰ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ï¼ŒConsumer ãŒå–ã‚Šå‡ºã™ã¾ã§ä¿å­˜ã•ã‚Œã¾ã™ï¼‰</p>
<p>ã¾ãŸï¼Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã«ã¯ Exchange ã¨å‘¼ã°ã‚Œã‚‹æ©Ÿèƒ½ãŒã‚ã‚Šï¼Œã©ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã©ã®ã‚ˆã†ã«é€ã‚‹ã‹ã‚’è¨­å®šã™ã‚‹æ©Ÿèƒ½ã‚‚ã‚ã‚Šã¾ã™ï¼ï¼ˆå³å¯†ã«ã¯ï¼ŒProducer ã¯ç›´æ¥ Queue ã«é€ä¿¡ã™ã‚‹ã®ã§ã¯ãªãï¼ŒExchange ã«é€ä¿¡ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ï¼‰</p>
<p>å®Ÿéš›ã«ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã®å½¹å‰²ã‚’æ‹…ã†ã‚‚ã®ã‚’ Broker ã¨å‘¼ã‚“ã ã‚Šã—ã¾ã™ï¼ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ <a href="https://www.rabbitmq.com/" target="_blank">RabbitMQ</a> ã‚„ <a href="https://redis.io/" target="_blank">Redis</a> ãªã©ãŒã‚ã‚Šï¼Œãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ <a href="https://aws.amazon.com/sqs/" target="_blank">Amazon Simple Queue Service (SQS)</a> ãŒã‚ã‚Šã¾ã™ï¼</p>
<p>å‚è€ƒ: <a href="https://www.cloudamqp.com/blog/what-is-message-queuing.html" target="_blank">What is message queuing?</a></p>
<h3 id="rabbitmqã‚’ä½¿ã£ãŸå®Ÿè£…">RabbitMQã‚’ä½¿ã£ãŸå®Ÿè£…</h3>
<p>ä»Šå›ã¯ RabbitMQ ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¾ã—ãŸï¼RabbitMQ ã¯ OSS ã® Message Broker ã§å‹•ä½œãŒé€Ÿãè»½é‡ã§ï¼Œè¤‡æ•°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ï¼ã„ãã¤ã‹ã®è¨€èªã§å®Ÿè£…å¯èƒ½ã§ã™ãŒï¼Œpython ã§æ‰±ã†å ´åˆã«ã¯ï¼Œ<code>pika</code> ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã“ã¨ã«ãªã‚Šã¾ã™ï¼</p>
<p>ä¾‹ãˆã°ï¼Œ<a href="https://docs.celeryq.dev/en/stable/" target="_blank">Celery</a> ã®ã‚ˆã†ãªåˆ†æ•£ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†ã“ã¨ã§éåŒæœŸå‡¦ç†ã‚’ã‚ˆã‚Šç°¡å˜ã«å®Ÿè£…ã§ãã¾ã™ãŒï¼ŒCelery è‡ªä½“ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã¯ã§ããªã„ãŸã‚ï¼ŒRabbitMQ ã‚„ Redis ã®ã‚ˆã†ãª Broker ãŒå¿…è¦ã«ãªã‚Šã¾ã™ï¼ä»Šå›ã¯ã“ã®ã‚ãŸã‚Šã® pub/sub ã®ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹ãŸã‚ã« Celery ã¯ä½¿ã‚ãšã« RabbitMQ ã® python ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ pika ã‚’ä½¿ã£ã¦å®Ÿè£…ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸï¼</p>
<p>RabbitMQ ã¯ docker ã‚³ãƒ³ãƒ†ãƒŠã§ç«‹ã¡ä¸Šã’ã¦ã„ã¦ï¼Œdefinitions.json ã¨ã„ã†å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’äº‹å‰ã«ç”¨æ„ã™ã‚‹ã“ã¨ã§ãã®ã‚¹ã‚­ãƒ¼ãƒã«åŸºã¥ã„ã¦ RabbitMQ ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ï¼</p>
<details>
<summary>definitions.json</summary>
<pre><code class="language-json">{
  &quot;rabbit_version&quot;: &quot;3.9.14&quot;,
  &quot;rabbitmq_version&quot;: &quot;3.9.14&quot;,
  &quot;product_name&quot;: &quot;RabbitMQ&quot;,
  &quot;product_version&quot;: &quot;3.9.14&quot;,
  &quot;users&quot;: [
    {
      &quot;name&quot;: &quot;guest&quot;,
      &quot;password&quot;: &quot;guest&quot;,
      &quot;hashing_algorithm&quot;: &quot;rabbit_password_hashing_sha256&quot;,
      &quot;tags&quot;: &quot;administrator&quot;,
      &quot;limits&quot;: {}
    }
  ],
  &quot;vhosts&quot;: [{ &quot;name&quot;: &quot;/&quot; }],
  &quot;permissions&quot;: [
    {
      &quot;user&quot;: &quot;guest&quot;,
      &quot;vhost&quot;: &quot;/&quot;,
      &quot;configure&quot;: &quot;.*&quot;,
      &quot;write&quot;: &quot;.*&quot;,
      &quot;read&quot;: &quot;.*&quot;
    }
  ],
  &quot;topic_permissions&quot;: [],
  &quot;parameters&quot;: [],
  &quot;global_parameters&quot;: [],
  &quot;policies&quot;: [],
  &quot;queues&quot;: [
    {
      &quot;name&quot;: &quot;queue.model.train&quot;,
      &quot;vhost&quot;: &quot;/&quot;,
      &quot;durable&quot;: true,
      &quot;auto_delete&quot;: false,
      &quot;arguments&quot;: { &quot;x-queue-type&quot;: &quot;classic&quot; }
    },
    {
      &quot;name&quot;: &quot;queue.model.predict&quot;,
      &quot;vhost&quot;: &quot;/&quot;,
      &quot;durable&quot;: true,
      &quot;auto_delete&quot;: false,
      &quot;arguments&quot;: { &quot;x-queue-type&quot;: &quot;classic&quot; }
    }
  ],
  &quot;exchanges&quot;: [],
  &quot;bindings&quot;: []
}
</code></pre>
</details>
<p>RabbitMQã«ã¯ä¸å¯§ãªTutorialsãŒã‚ã‚‹ã®ã§ï¼Œãã‚Œã‚’èª­ã‚€ã¨ç†è§£ãŒé€²ã‚€ã¨æ€ã„ã¾ã™ï¼</p>
<h2 id="ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ">ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ</h2>
<p>éåŒæœŸå‡¦ç†ã‚’è¡Œã†ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹æˆã¯å›³ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼Producer/Broker/Consumer ã¨ã‚³ãƒ³ãƒ†ãƒŠã‚’3ã¤ç”¨æ„ã—ã¦ã„ã¾ã™ï¼</p>
<p>å›³ã®å³ä¸‹ã«ã‚ã‚‹ Result Stores ã¯ã‚¿ã‚¹ã‚¯ã®å‡¦ç†çµæœã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã«ãªã‚Šã¾ã™ï¼Result Stores ã«ã¯ PostgreSQL ã‚„ MySQL ãªã©ã®DBã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã—ï¼ŒRedis ã‚‚ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼Redis ã¯ Broker ã¨ã—ã¦ã‚‚ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ï¼Œä¸¡æ–¹ã‚’1ã¤ã§æ‹…ã†ã“ã¨ãŒå¯èƒ½ã§ã™ï¼ä»Šå›ã¯ãƒ¢ãƒ‡ãƒ«ã‚’ S3 ã«ä¿å­˜ã™ã‚‹ã ã‘ã¨ã—ã¦ï¼Œå‡¦ç†çµæœã‚’ DB ã«ä¿å­˜ã—ãŸã‚Šã¯ã—ã¦ã„ãªã„ã§ã™ï¼</p>
<ul>
<li>Producer: æ©Ÿæ¢°å­¦ç¿’ã‚¿ã‚¹ã‚¯ã‚’è¡Œã†ãŸã‚ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒã‚¹ãƒˆã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠï¼ˆ=FastAPIï¼‰</li>
<li>Broker: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã®å½¹å‰²ã‚’æ‹…ã†ã‚³ãƒ³ãƒ†ãƒŠï¼ˆ=RabbitMQï¼‰</li>
<li>Consumer: ã‚¿ã‚¹ã‚¯ã‚’å®Ÿéš›ã«å®Ÿè¡Œã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ</li>
<li>Storage: ãƒ¢ãƒ‡ãƒ«ã‚’ä¿å­˜ã™ã‚‹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆ=S3ï¼‰</li>
</ul>
<p><img class="img-zoomable" src="../../img/teamaya-async-img1.png" alt="ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¼" />
</p>
<p>docker-compose.yml ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹æˆã«ãªã‚Šã¾ã™ï¼</p>
<details>
<summary>docker-compose.yml</summary>
<pre><code class="language-dockerfile">version: '3.8'

# Common definition
x-template: &amp;template
  volumes:
      - ~/.gcp:/root/.gcp:cached
      - ~/.aws:/root/.aws:cached
      - ./app:/opt/program:cached
  env_file:
      - .env
  environment:
      TZ: Asia/Tokyo
      LANG: 'ja_JP.UTF-8'
  restart: always
  tty: true

services:
  producer:
    # FastAPI for producer
    container_name: producer
    build:
      context: .
    ports:
      - 5000:5000
    command: [&quot;uvicorn&quot;, &quot;main:app&quot;, &quot;--reload&quot;, &quot;--host&quot;, &quot;0.0.0.0&quot;, &quot;--port&quot;, &quot;5000&quot;, &quot;--access-log&quot;]
    depends_on:
      - rabbitmq
    &lt;&lt;: *template

  consumer:
    container_name: consumer
    hostname: consumer
    build:
      context: .
    command: [&quot;python3&quot;, &quot;consumer/consumer.py&quot;, &quot;--num_threads&quot;, &quot;2&quot;]
    depends_on:
      - rabbitmq
    &lt;&lt;: *template

  rabbitmq:
    image: rabbitmq:3.9-management
    container_name: rabbitmq
    hostname: rabbitmq
    restart: always
    volumes:
      # - ./app/rabbitmq/etc:/etc/rabbitmq/rabbitmq
      - ./app/rabbitmq/etc/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
      - ./app/rabbitmq/etc/definitions.json:/etc/rabbitmq/definitions.json
      - ./app/rabbitmq/data:/var/lib/rabbitmq
      - ./app/rabbitmq/logs:/var/log/rabbitmq
      - ~/.aws:/root/.aws:cached
    ports:
      # AMQP protocol port
      - 5672:5672
      # HTTP management UI
      - 15672:15672
    environment:
      TZ: Asia/Tokyo
      LANG: 'ja_JP.UTF-8'
    env_file:
      - .env

# networks:
#   default:
#     external:
#       name: teamaya-network-async
</code></pre>
</details>
<p>ä»Šå›ã®ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ï¼å°‘ã—å†—é•·ãªæ§‹æˆã«ãªã£ã¦ã„ã¾ã™ãŒï¼Œ<code>./app/producer</code> ã¨ <code>./app/consumer</code> é…ä¸‹ã« Producer ã¨ Consumer ã®å‡¦ç†ã‚’è¡Œã†ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚ã‚Šã¾ã™ï¼</p>
<pre><code class="language-text">.
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ README.md
â”œâ”€â”€ app
â”‚   â”œâ”€â”€ consumer
â”‚   â”‚   â”œâ”€â”€ base.py
â”‚   â”‚   â”œâ”€â”€ consumer.py
â”‚   â”‚   â””â”€â”€ tasks.py
â”‚   â”œâ”€â”€ logger.py
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ producer
â”‚   â”‚   â”œâ”€â”€ base.py
â”‚   â”‚   â”œâ”€â”€ producer.py
â”‚   â”‚   â””â”€â”€ schema.py
â”‚   â”œâ”€â”€ rabbitmq
â”‚   â”‚   â””â”€â”€ etc
â”‚   â”‚       â”œâ”€â”€ definitions.json
â”‚   â”‚       â””â”€â”€ rabbitmq.conf
â”‚   â””â”€â”€ test
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ conftest.py
â”‚       â”œâ”€â”€ data
â”‚       â”‚   â””â”€â”€ test_diabetes.csv
â”‚       â””â”€â”€ unit
â”‚           â”œâ”€â”€ __init__.py
â”‚           â””â”€â”€ test_tasks.py
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ requirements.lock
â””â”€â”€ requirements.txt
</code></pre>
<h2 id="producerã®å®Ÿè£…">Producerã®å®Ÿè£…</h2>
<p>ãã‚Œãã‚Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã®èª¬æ˜ã‚’ã—ã¦ãŠãã¨ï¼Œ</p>
<ul>
<li><code>base.py</code>: RabbitMQ ã«æ¥ç¶šã™ã‚‹ãŸã‚ã®åˆæœŸåŒ–ã‚„ Consumer ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®å‡¦ç†ã‚’å®Ÿè£…ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«</li>
<li><code>producer.py</code>: <code>base.py</code> ã®ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ã¦ï¼Œå€‹åˆ¥ã®ã‚¿ã‚¹ã‚¯ã«åˆã‚ã›ã¦é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å®Ÿè¡Œã™ã‚‹ API ã‚’å®Ÿè£…ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«</li>
<li><code>schema.py</code>: ãƒ‡ãƒ¼ã‚¿ã®å…¥å‡ºåŠ›ã®ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«
<ul>
<li>FastAPI ã§ã¯å…¥å‡ºåŠ›ã‚’ <code>Pydantic</code> ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç”¨ã„ã¦ Data validation ã‚’è¡Œã„ã¾ã™ï¼å‹ãƒ’ãƒ³ãƒˆã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã«ãªã‚Šã¾ã™</li>
</ul>
</li>
</ul>
<details>
<summary>producer.py</summary>
<pre><code class="language-python">import ast
import uuid

from fastapi import APIRouter
from logger import get_logger

from producer.base import BaseProducer, QueueNames, RepQueueNames
from producer.schema import ApiSchemaPredict, ApiSchemaTrain, ProducerResult

LOGGER = get_logger()

router = APIRouter(prefix='', tags=[&quot;producers&quot;])


class ProducerTrain(BaseProducer):
    def __init__(self, queue_name: QueueNames, rep_queue_name: RepQueueNames):
        BaseProducer.__init__(self, queue_name, rep_queue_name)

    def run(self, params: ApiSchemaTrain):
        &quot;&quot;&quot;Run to send message to train consumer

        Args:
            params (ApiSchemaTrain): schema for train
        &quot;&quot;&quot;
        model_id = str(uuid.uuid4())
        message = {
            &quot;model_id&quot;: model_id,
            &quot;dataset_id&quot;: params.dataset_id,
            &quot;features&quot;: params.features,
            &quot;target&quot;: params.target
        }

        # self.send_message_to_consumer(message)
        LOGGER.info(&quot;Produce message for train.&quot;)
        response = self.send_message_to_consumer(message)
        response = ast.literal_eval(response.decode())
        LOGGER.info(f&quot;Reply Response from consumer: {response}&quot;)

        return ProducerResult(message=response)


class ProducerPredict(BaseProducer):
    def __init__(self, queue_name: QueueNames, rep_queue_name: RepQueueNames):
        BaseProducer.__init__(self, queue_name, rep_queue_name)

    def run(self, params: ApiSchemaPredict):
        &quot;&quot;&quot;Run to send message to predict consumer

        Args:
            params (ApiSchemaPredict): schema for predict
        &quot;&quot;&quot;
        message = {
            &quot;model_id&quot;: params.model_id,
            &quot;dataset_id&quot;: params.dataset_id,
            &quot;input_data&quot;: params.input_data
        }

        LOGGER.info(&quot;Produce message for predict.&quot;)
        response = self.send_message_to_consumer(message)
        response = ast.literal_eval(response.decode())
        LOGGER.info(f&quot;Reply Response from consumer: {response}&quot;)

        return ProducerResult(message=response)


@router.post(&quot;/train&quot;, response_model=ProducerResult, name=&quot;train&quot;)
async def train(params: ApiSchemaTrain) -&gt; ProducerResult:
    &quot;&quot;&quot;Train model&quot;&quot;&quot;
    return ProducerTrain(queue_name='queue.model.train', rep_queue_name='queue.reply.train').run(params)


@router.post(&quot;/predict&quot;, response_model=ProducerResult, name=&quot;predict&quot;)
async def predict(params: ApiSchemaPredict) -&gt; ProducerResult:
    &quot;&quot;&quot;Predict model&quot;&quot;&quot;
    return ProducerPredict(queue_name='queue.model.predict', rep_queue_name='queue.reply.predict').run(params)
</code></pre>
</details>
<p><code>ProducerTrain</code> ã¨ <code>ProducerPredict</code> ã¯ã‚¿ã‚¹ã‚¯å®Ÿè¡Œç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã‚­ãƒ¥ãƒ¼ã® <code>queue_name</code> ã¨ Consumer å´ã‹ã‚‰ã®è¿”ä¿¡ç”¨ã®ã‚­ãƒ¥ãƒ¼ã§ã‚ã‚‹ <code>rep_queue_name</code> ã®2ã¤ã‚’å¼•æ•°ã«å–ã‚Šã¾ã™ï¼å®Ÿéš›ã®å­¦ç¿’ã‚„äºˆæ¸¬å‡¦ç†ã‚’è¡Œã†éƒ¨åˆ†ã¯ Consumer å´ã§å®Ÿè£…ã—ã¦ã„ã¾ã™ï¼</p>
<details>
<summary>base.py</summary>
<pre><code class="language-python">import json
import os
import uuid
from typing import Literal

import pika
from logger import get_logger

LOGGER = get_logger()

# Possible values as queue name
QueueNames = Literal['queue.model.train', 'queue.model.predict']
RepQueueNames = Literal['queue.reply.train', 'queue.reply.predict']


class BaseProducer:
    def __init__(self, queue_name: QueueNames, rep_queue_name: RepQueueNames):
        self.queue_name = queue_name
        self.rep_queue_name = rep_queue_name
        self.pika_params = pika.ConnectionParameters(
            host=&quot;rabbitmq&quot;,
            port=os.getenv('RABBITMQ_PORT', 5672),
            connection_attempts=10,
            heartbeat=0
        )
        self.connection = pika.BlockingConnection(self.pika_params)
        self.channel = self.connection.channel()
        LOGGER.info('Pika connection initialized.')

        result = self.channel.queue_declare(queue=self.rep_queue_name, exclusive=True)
        self.callback_queue = result.method.queue
        self.channel.basic_consume(queue=self.callback_queue, on_message_callback=self.on_response, auto_ack=True)

    def on_response(self, ch, method, props, body):
        if self.corr_id == props.correlation_id:
            self.response = body

    def run(self):
        raise NotImplementedError()

    def send_message_to_consumer(self, message: dict):
        &quot;&quot;&quot;Send message

        Args:
            message (dict): message info
        &quot;&quot;&quot;
        self.response = None
        self.corr_id = str(uuid.uuid4())
        message_json = json.dumps(message)

        self.channel.basic_publish(
            exchange=&quot;&quot;,
            routing_key=self.queue_name,
            body=message_json,
            properties=pika.BasicProperties(
                content_type='application/json',
                delivery_mode=2,  # make message persistent
                reply_to=self.callback_queue,
                correlation_id=self.corr_id
            )
        )

        LOGGER.info(f&quot;Sent message. [q] '{self.queue_name}' [x] Body: {message_json=}&quot;)

        while self.response is None:
            self.connection.process_data_events()

        self.close()
        return self.response

    def close(self):
        self.channel.close()
        self.connection.close()
</code></pre>
</details>
<ul>
<li>
<p><code>__init__</code> é–¢æ•°:</p>
<ul>
<li>RabbitMQ ã®ã‚µãƒ¼ãƒãƒ¼ã¨æ¥ç¶šã™ã‚‹ãŸã‚ã« <code>pika.BlockingConnection()</code> ã§ <code>host</code> , <code>port</code> ãªã©ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã‚’è¡Œã†</li>
<li>Consumer ã‹ã‚‰ã® Reply ç”¨ã« rep_queue_name ã«æŒ‡å®šã—ãŸã‚­ãƒ¥ãƒ¼åã§ callback_queue ã‚’ä½œæˆ</li>
<li>basic_consume ã§ã¯ subscribe ã™ã‚‹ã‚­ãƒ¥ãƒ¼ãŒå­˜åœ¨ã™ã‚Œã°ãã‚Œã‚’å®Ÿè¡Œ</li>
</ul>
</li>
<li>
<p><code>send_message_to_consumer</code> é–¢æ•°:</p>
<ul>
<li>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ json.dump ã—ï¼Œbasic_publish ã® body ã«ã¤ã‚ã¦ Exchange ã«é€ã‚‹</li>
</ul>
</li>
</ul>
<h2 id="consumer-ã®å®Ÿè£…">Consumer ã®å®Ÿè£…</h2>
<p>ãã‚Œãã‚Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã®èª¬æ˜ã‚’ã—ã¦ãŠãã¨ï¼Œ</p>
<ul>
<li><code>base.py</code>: RabbitMQ ã«æ¥ç¶šã—ã¦ã‚­ãƒ¥ãƒ¼ã«ã‚ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ï¼Œå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«
<ul>
<li>callback éƒ¨åˆ†ã¯ <code>tasks.py</code> ã§å®Ÿè£…ã—ã¦ã„ã¾ã™</li>
</ul>
</li>
<li><code>consumer.py</code>: ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã‚’æ±ºã‚ã‚‹ <code>num_threads</code> ã‚’ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã«å–ã‚Šï¼Œã‚³ãƒ³ãƒ†ãƒŠä¸Šã§ã¯ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå®Ÿè¡Œã•ã‚Œã¾ã™</li>
<li><code>tasks.py</code>: æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«ä½œæˆã‚„å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦äºˆæ¸¬ã‚’è¡Œã†å‡¦ç†ã‚’å®Ÿè£…ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«
<ul>
<li>callback ãƒ¡ã‚½ãƒƒãƒ‰ã«å®Ÿè¡Œã—ãŸã„å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™</li>
<li><code>if __name__ == &quot;__main__&quot;:</code> ä»¥ä¸‹ã«ã¯ <a href="https://cml.dev/" target="_blank">Continuous Machine Learning (CML)</a> ã§åˆ©ç”¨ã™ã‚‹ CT ç”¨ã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ï¼ï¼ˆCML ã«é–¢ã—ã¦ã¯åˆ¥ã§ãƒ–ãƒ­ã‚°ã‚’æ›¸ã“ã†ã¨æ€ã„ã¾ã™ï¼‰</li>
</ul>
</li>
</ul>
<details>
<summary>tasks.py</summary>
<pre><code class="language-python">import json
import os
import sys
import traceback
from typing import Any, Dict

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import pika
from logger import get_logger
from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split

from base import BaseConsumer, EvalMetrics, QueueNames

LOGGER = get_logger()
S3_BUCKET_NAME = os.getenv('S3_BUCKET_NAME')
S3_PATH_NAME = os.getenv('S3_PATH_NAME')
S3_MODEL_PATH_NAME = os.getenv('S3_MODEL_PATH_NAME')


class TrainConsumer(BaseConsumer):
    def __init__(self, queue_name: QueueNames):
        BaseConsumer.__init__(self, queue_name)

    def callback(self, ch, method, props, body):
        params = self.body2dict(body)

        payload = {
            'status': 'TASK_RECEIVED',
            'model_id': params['model_id']
        }
        response = json.dumps(payload)

        ch.basic_publish(
            exchange='',
            routing_key=props.reply_to,
            properties=pika.BasicProperties(correlation_id=props.correlation_id),
            body=response
        )
        # ch.basic_ack(delivery_tag=method.delivery_tag)

        self.download_from_s3(S3_BUCKET_NAME, S3_PATH_NAME, 'data/', params['dataset_id'] + '.csv')
        LOGGER.info(&quot;Download dataset from S3.&quot;)

        dataset_path = 'data/' + params['dataset_id'] + '.csv'
        df = pd.read_csv(dataset_path)
        LOGGER.info(&quot;Read csv file and transform to dataframe.&quot;)

        try:
            result = train(df, params)

            # save model
            model_path = 'data/model.pkl'
            self.save_model(result['model'], model_path)
            LOGGER.info(&quot;Save trained model to local.&quot;)

            # upload model to cloud storage
            model_id = params['model_id']
            self.upload_to_s3(S3_BUCKET_NAME, S3_MODEL_PATH_NAME + f'{model_id}/', 'data/', 'model.pkl')
            LOGGER.info(&quot;Upload trained model to S3.&quot;)
            LOGGER.info(&quot;TASK_COMPLETED&quot;)
        except Exception as e:
            _, _, tb = sys.exc_info()
            LOGGER.error(
                f&quot;Exception Error: {e} || Type: {str(type(e))} || Traceback Message: {traceback.format_tb(tb)}&quot;)
            LOGGER.error(&quot;TASK_ERROR&quot;)


class PredictConsumer(BaseConsumer):
    def __init__(self, queue_name: QueueNames):
        BaseConsumer.__init__(self, queue_name)

    def callback(self, ch, method, props, body):
        params = self.body2dict(body)
        model_id = params['model_id']
        self.download_from_s3(S3_BUCKET_NAME, S3_MODEL_PATH_NAME + f'{model_id}/', 'data/', 'model.pkl')
        LOGGER.info(&quot;Download model file from S3.&quot;)

        model_path = 'data/model.pkl'
        model = self.load_model(model_path)
        LOGGER.info(&quot;Load model for prediction.&quot;)

        try:
            result = predict(model, params)

            payload = {
                'status': 'TASK_COMPLETED',
                'pred_proba': result['pred_proba']
            }
            response = json.dumps(payload)
        except Exception as e:
            _, _, tb = sys.exc_info()
            LOGGER.error(
                f&quot;Exception Error: {e} || Type: {str(type(e))} || Traceback Message: {traceback.format_tb(tb)}&quot;)

            payload = {
                'status': 'TASK_ERROR',
                'pred_proba': None
            }
            response = json.dumps(payload)

        ch.basic_publish(
            exchange='',
            routing_key=props.reply_to,
            properties=pika.BasicProperties(correlation_id=props.correlation_id),
            body=response
        )
        # ch.basic_ack(delivery_tag=method.delivery_tag)


def train(df: pd.DataFrame, params: dict) -&gt; Dict[str, Any]:
    &quot;&quot;&quot;Train machine learning model (RandomForestRegressor)

    Args:
        df (pd.DataFrame): dataset for training model
        params (dict): parameters for training
    &quot;&quot;&quot;
    features = params['features']
    target = params['target']
    X, y = df[features], df[target].values

    # train/test split
    X_train, X_valid, y_train, y_valid = train_test_split(X, y, test_size=0.2, random_state=42)

    LOGGER.info(&quot;Start model training.&quot;)
    # machine learning model: RandomForestRegressor
    reg_model = RandomForestRegressor(max_depth=3, random_state=42, n_estimators=100)
    reg_model.fit(X_train, y_train)
    LOGGER.info(&quot;Model fit for training.&quot;)

    # evaluate model
    pred = reg_model.predict(X_valid)

    # evaluate metrics
    eval_metrics = EvalMetrics()
    rmse = eval_metrics.rmse_score(y_valid, pred)
    LOGGER.info(&quot;Evaluate metrics=RMSE for valid dataset : %.3f&quot; % rmse)
    LOGGER.info(&quot;Finish model training.&quot;)

    result = {
        'y_pred': pred,
        'y_true': y_valid,
        'metrics': {'rmse': rmse},
        'model': reg_model
    }

    return result


def predict(model: object, params: dict) -&gt; Dict[str, Any]:
    &quot;&quot;&quot;Prediction for dataset using trained model

    Args:
        model (object): trained model
        params (dict): parameters for prediction

    Returns:
        float: predict probability
    &quot;&quot;&quot;
    input_data = params['input_data']
    pred_proba = model.predict(pd.DataFrame([input_data]))
    result = {
        'pred_proba': pred_proba[0]
    }

    return result
</code></pre>
</details>
<ul>
<li>å­¦ç¿’ãƒ‘ãƒ¼ãƒˆ
<ul>
<li>ä»Šå›ï¼Œæ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã¯ä½•ã§ã‚‚ã‚ˆã‹ã£ãŸã®ã§ï¼ŒRandomForest ã§å›å¸°ã‚’è¡Œã†å‡¦ç†ã«ã—ã¦ã„ã¾ã™</li>
<li>å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã¯ S3 ã«ä¿å­˜ã—ã¦ã„ã‚‹ã®ã§ï¼Œã“ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ <code>.env</code> ãƒ•ã‚¡ã‚¤ãƒ«ã«è‡ªèº«ã§åˆ©ç”¨ã—ã¦ã„ã‚‹ AWS ã®ãƒã‚±ãƒƒãƒˆæƒ…å ±ãªã©ã‚’è¼‰ã›ã¦ä¸‹ã•ã„</li>
</ul>
</li>
</ul>
<pre><code class="language-bash">S3_BUCKET_NAME = os.getenv('S3_BUCKET_NAME')
S3_PATH_NAME = os.getenv('S3_PATH_NAME')
S3_MODEL_PATH_NAME = os.getenv('S3_MODEL_PATH_NAME')
</code></pre>
<p>ãƒ¢ãƒ‡ãƒ«å­¦ç¿’æ™‚ã®ãƒ¡ã‚¿æƒ…å ±ã‚‚ DB ã«æ®‹ã—ã¦ãŠãã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ãŒï¼Œä»Šå›ã¯ãã®éƒ¨åˆ†ã¯å®Ÿè£…ã—ã¦ã„ãªã„ã§ã™ğŸ™</p>
<ul>
<li>äºˆæ¸¬ãƒ‘ãƒ¼ãƒˆ
<ul>
<li>S3 ã«ä¿å­˜ã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ï¼Œä¸ãˆã‚‰ãŸãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦äºˆæ¸¬ã‚’è¡Œã„ã¾ã™</li>
<li>ãƒ¢ãƒ‡ãƒ« ID ã¯å­¦ç¿’æ™‚ã«ç™ºè¡Œã•ã‚ŒãŸ UUID ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã™ãŒï¼Œå‡ºåŠ›ã•ã‚ŒãŸãƒ­ã‚°ã‹ã‚‰æ‹¾ã†ã®ã§ã¡ã‚‡ã£ã¨ã„ã‘ã¦ãªã„ã§ã™ãŒãƒ¢ãƒƒã‚¯ãªã®ã§ã”å‹˜å¼ã‚’&hellip;</li>
</ul>
</li>
</ul>
<details>
<summary>consumer.py</summary>
<pre><code class="language-python">from concurrent.futures import ThreadPoolExecutor

import click

import tasks


@click.command()
@click.option(&quot;--num_threads&quot;, type=int, help='the number of threads', default=1)
@click.option(&quot;--max_workers&quot;, type=int, help='the number of max workers', default=None)
def main(num_threads: int, max_workers: int):
    # Consumer execution
    with ThreadPoolExecutor(max_workers=max_workers) as executor:
        for _ in range(num_threads):
            for task in [
                tasks.TrainConsumer(queue_name='queue.model.train'),
                tasks.PredictConsumer(queue_name='queue.model.predict')
            ]:
                executor.submit(task.run)


if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
</details>
<p>å¼•æ•°ã«æŒ‡å®šã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã«å¿œã˜ã¦ Consumer ãŒè¤‡æ•°ç«‹ã¡ä¸ŠãŒã‚Šã¾ã™ï¼</p>
<h2 id="å®Ÿè¡Œçµæœ">å®Ÿè¡Œçµæœ</h2>
<p><code>docker compose up</code> ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¦ï¼Œ<code>http://localhost:5000/docs</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ Swagger ã«ã‚ˆã‚‹è¡¨ç¤ºãŒã•ã‚Œã¾ã™ï¼FastAPI ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ OpenAPI ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãã‚Œï¼ŒSwagger ã‚„ ReDoc ã§è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼</p>
<p>ã“ã®è¾ºã¯å€‹äººçš„ã«ã¨ã¦ã‚‚ä¾¿åˆ©ã ãªã¨æ€ã£ã¦ã„ã¦ï¼Œãƒ‡ãƒ¼ã‚¿ã‚’ç°¡å˜ã« GET/POST ã™ã‚‹ã“ã¨ã§å‹•ä½œã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ãã¾ã™ï¼</p>
<ul>
<li>Swagger ã®ç”»é¢</li>
</ul>
<p><img class="img-zoomable" src="../../img/teamaya-async-img2.png" alt="Swagger ã®ç”»é¢" />
</p>
<ul>
<li>ReDoc ã®ç”»é¢</li>
</ul>
<p><img class="img-zoomable" src="../../img/teamaya-async-img3.png" alt="ReDoc ã®ç”»é¢" />
</p>
<h3 id="å­¦ç¿’ç·¨">å­¦ç¿’ç·¨</h3>
<p><code>/train</code> ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ POST ã—ã¾ã™ï¼äº‹å‰ã« S3 ã«ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆåã‚’ <code>dataset_id</code> ã«ï¼Œä½¿ç”¨ã™ã‚‹ç‰¹å¾´é‡ï¼ˆèª¬æ˜å¤‰æ•°ï¼‰ã‚’ <code>features</code> ã«ï¼Œç›®çš„å¤‰æ•°ã‚’ <code>target</code> ã«æŒ‡å®šã—ã¾ã™ï¼</p>
<pre><code class="language-bash">curl -X 'POST' \
  'http://localhost:5000/train' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  &quot;dataset_id&quot;: &quot;diabetes&quot;,
  &quot;features&quot;: [&quot;age&quot;, &quot;bmi&quot;, &quot;bp&quot;, &quot;s1&quot;, &quot;s2&quot;, &quot;s3&quot;, &quot;s4&quot;, &quot;s5&quot;, &quot;s6&quot;],
  &quot;target&quot;: &quot;target&quot;
}'
</code></pre>
<p>å‡ºåŠ›ã•ã‚Œã‚‹ãƒ­ã‚°ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ï¼</p>
<ul>
<li>4è¡Œç›®ã¯ Producer ãŒã‚­ãƒ¥ãƒ¼ã«å¯¾ã—ã¦é€ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆConsumer ã«æ¸¡ã—ãŸã„æƒ…å ±ï¼‰</li>
<li>7è¡Œç›®ï¼ˆä¸­ç•¥å¾Œ1è¡Œç›®ï¼‰ã¯ Consumer ã‹ã‚‰ã® Reply ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</li>
<li>æœ€å¾Œã® Consumer ã‹ã‚‰ã®ãƒ­ã‚°ã¯å­¦ç¿’å‡¦ç†ã‚’å®Ÿè¡Œä¸­ã«å‡ºåŠ›ã•ã‚Œã‚‹ãƒ­ã‚°</li>
</ul>
<pre><code class="language-text">producer  | [2022-04-24 15:49:09] [ INFO] Created channel=1
producer  | [2022-04-24 15:49:09] [ INFO] Pika connection initialized.
producer  | [2022-04-24 15:49:09] [ INFO] Produce message for train.
producer  | [2022-04-24 15:49:09] [ INFO] Sent message. [q] 'queue.model.train' [x] Body: message_json='{&quot;model_id&quot;: &quot;c7632288-442d-44c5-9102-31ccda2af6b7&quot;, &quot;dataset_id&quot;: &quot;diabetes&quot;, &quot;features&quot;: [&quot;age&quot;, &quot;bmi&quot;, &quot;bp&quot;, &quot;s1&quot;, &quot;s2&quot;, &quot;s3&quot;, &quot;s4&quot;, &quot;s5&quot;, &quot;s6&quot;], &quot;target&quot;: &quot;target&quot;}'
consumer  | [2022-04-24 15:49:09] [ INFO] Convert message to dict type.
~ä¸­ç•¥~
producer  | [2022-04-24 15:49:09] [ INFO] Reply Response from consumer: {'status': 'TASK_RECEIVED', 'model_id': 'c7632288-442d-44c5-9102-31ccda2af6b7'}
producer  | INFO:     172.24.0.1:57222 - &quot;POST /train HTTP/1.1&quot; 200 OK
rabbitmq  | 2022-04-24 06:49:09.367236+00:00 [info] &lt;0.5900.0&gt; closing AMQP connection &lt;0.5900.0&gt; (172.24.0.4:46266 -&gt; 172.24.0.2:5672, vhost: '/', user: 'guest')
consumer  | [2022-04-24 15:49:09] [ INFO] Found credentials in shared credentials file: ~/.aws/credentials
consumer  | [2022-04-24 15:49:09] [ INFO] Download dataset from S3.
consumer  | [2022-04-24 15:49:09] [ INFO] Read csv file and transform to dataframe.
consumer  | [2022-04-24 15:49:09] [ INFO] Start model training.
consumer  | [2022-04-24 15:49:09] [ INFO] Model fit for training.
consumer  | [2022-04-24 15:49:09] [ INFO] Evaluate metrics=RMSE for valid dataset : 53.039
consumer  | [2022-04-24 15:49:09] [ INFO] Finish model training.
consumer  | [2022-04-24 15:49:09] [ INFO] Save trained model to local.
consumer  | [2022-04-24 15:49:10] [ INFO] Upload trained model to S3.
consumer  | [2022-04-24 15:49:10] [ INFO] TASK_COMPLETED
</code></pre>
<h3 id="äºˆæ¸¬ç·¨">äºˆæ¸¬ç·¨</h3>
<p><code>/predict</code> ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ POST ã—ã¾ã™ï¼<code>model_id</code> ã‚’å…ƒã«å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚’ S3 ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼<code>input_data</code> ã«ã¯ï¼Œãƒ¢ãƒ‡ãƒ«ã«å…¥åŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’è¾æ›¸å½¢å¼ã§ç‰¹å¾´é‡ã¨ãã®å€¤ã¨ã„ã†çµ„ã§æ¸¡ã—ã¾ã™ï¼<br>
â€» <code>model_id</code> ã¯å­¦ç¿’ç·¨ã®ãƒ­ã‚°å‡ºåŠ›ã«ã‚ã‚‹ <code>model_id</code> ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼</p>
<pre><code class="language-bash">curl -X 'POST' \
  'http://localhost:5000/predict' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  &quot;model_id&quot;: &quot;c7632288-442d-44c5-9102-31ccda2af6b7&quot;,
  &quot;dataset_id&quot;: &quot;diabetes&quot;,
  &quot;input_data&quot;: {
    &quot;age&quot;: 0.038076,
    &quot;bmi&quot;: 0.061696,
    &quot;bp&quot;: 0.021872,
    &quot;s1&quot;: -0.044223,
    &quot;s2&quot;: -0.034821,
    &quot;s3&quot;: -0.043401,
    &quot;s4&quot;: -0.002592,
    &quot;s5&quot;: 0.019908,
    &quot;s6&quot;: -0.017646
  }
}'
</code></pre>
<p>å‡ºåŠ›ã•ã‚Œã‚‹ãƒ­ã‚°ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ï¼</p>
<ul>
<li>4è¡Œç›®ã¯ Producer ãŒã‚­ãƒ¥ãƒ¼ã«å¯¾ã—ã¦é€ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆConsumer ã«æ¸¡ã—ãŸã„æƒ…å ±ï¼‰</li>
<li>5è¡Œç›®ã® Consumer ã‹ã‚‰ã®ãƒ­ã‚°ã¯äºˆæ¸¬å‡¦ç†ã‚’å®Ÿè¡Œä¸­ã«å‡ºåŠ›ã•ã‚Œã‚‹ãƒ­ã‚°</li>
<li>ï¼ˆä¸­ç•¥å¾Œ1è¡Œç›®ï¼‰ã¯ Consumer ã‹ã‚‰ã® Reply ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ï¼Œäºˆæ¸¬çµæœãŒå…¥ã£ã¦ã„ã¾ã™</li>
</ul>
<pre><code class="language-text">producer  | [2022-04-24 18:00:16] [ INFO] Created channel=1
producer  | [2022-04-24 18:00:16] [ INFO] Pika connection initialized.
producer  | [2022-04-24 18:00:16] [ INFO] Produce message for predict.
producer  | [2022-04-24 18:00:16] [ INFO] Sent message. [q] 'queue.model.predict' [x] Body: message_json='{&quot;model_id&quot;: &quot;c7632288-442d-44c5-9102-31ccda2af6b7&quot;, &quot;dataset_id&quot;: &quot;diabetes&quot;, &quot;input_data&quot;: {&quot;age&quot;: 0.038076, &quot;bmi&quot;: 0.061696, &quot;bp&quot;: 0.021872, &quot;s1&quot;: -0.044223, &quot;s2&quot;: -0.034821, &quot;s3&quot;: -0.043401, &quot;s4&quot;: -0.002592, &quot;s5&quot;: 0.019908, &quot;s6&quot;: -0.017646}}'
consumer  | [2022-04-24 18:00:16] [ INFO] Convert message to dict type.
consumer  | [2022-04-24 18:00:16] [ INFO] Download model file from S3.
consumer  | [2022-04-24 18:00:16] [ INFO] Load model for prediction.
~ä¸­ç•¥~
producer  | [2022-04-24 18:00:16] [ INFO] Reply Response from consumer: {'status': 'TASK_COMPLETED', 'pred_proba': 208.6445780005619}
rabbitmq  | 2022-04-24 09:00:16.565636+00:00 [info] &lt;0.8348.0&gt; closing AMQP connection &lt;0.8348.0&gt; (172.24.0.4:46664 -&gt; 172.24.0.2:5672, vhost: '/', user: 'guest')
producer  | INFO:     172.24.0.1:57624 - &quot;POST /predict HTTP/1.1&quot; 200 OK
</code></pre>
<h2 id="ãŠã‚ã‚Šã«">ãŠã‚ã‚Šã«</h2>
<p>FastAPI ã¨ RabbitMQ ã‚’ç”¨ã„ã¦ WebAPI å½¢å¼ã§ï¼Œæ©Ÿæ¢°å­¦ç¿’ã‚¿ã‚¹ã‚¯ã®éåŒæœŸå‡¦ç†ã‚’è¡Œã†æ¤œè¨¼ã‚’ã—ã¾ã—ãŸï¼éåŒæœŸå‡¦ç†ã ã£ãŸã‚Šï¼ŒRPC ã‚„ Pub/Sub ã®ä»•çµ„ã¿ã‚’å°‘ã—ã¯ç†è§£ã§ããŸã‹ãªã¨æ€ã„ã¾ã™ï¼</p>
<p>ä»Šå›ã¯ DB ã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ãŸã‚Š DB å‘¨ã‚Šã®å‡¦ç†ã¯å®Ÿè£…ã—ã¦ã„ãªã„ã®ã§ï¼Œã“ã®è¾ºã‚‚æ™‚é–“ãŒã‚ã‚Œã°å®Ÿè£…ã§ãã‚Œã°ã¨æ€ã„ã¾ã™&hellip;</p>
<p>éåŒæœŸå‡¦ç†ã‚’è¡Œã†ä¸Šã§ãƒ¡ã‚¤ãƒ³ã®å½¹å‰²ã‚’æœãŸã—ãŸ RabbitMQ ã«ã¤ã„ã¦ã‚‚ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã¨ï¼ŒOSS ã§ç°¡å˜ã«éåŒæœŸå‡¦ç†ã‚’è¡Œãˆã‚‹ä¾¿åˆ©ãªæŠ€è¡“ã ã¨æ€ã„ã¾ã™ï¼Producer/Exchange/Queue/Consumer ã®é–¢ä¿‚æ€§ã‚‚ Tutorials ã®å›³ãªã©ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã‚„ã™ããªã‚‹ã®ã§ï¼Œã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãªãŒã‚‰æ¯”è¼ƒçš„å®¹æ˜“ã«å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸï¼<br>
ä¸€æ–¹ã§ï¼ŒConsumer ã‹ã‚‰ Producer ã« Reply ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹å ´åˆã«ï¼Œã©ã®ã‚ˆã†ã«å®Ÿè£…ã™ã‚Œã°ã„ã„ã‹ãŒåˆ†ã‹ã‚Šã¥ã‚‰ãï¼Œå€‹äººçš„ã«ã¯ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆã§ã—ãŸï¼</p>
<p>ã‚ã¨ï¼Œãªã«ã’ã« FastAPI ã‚‚ã»ã¨ã‚“ã©ä½¿ã£ãŸã“ã¨ãªã‹ã£ãŸã®ã§è‰¯ã„å‹‰å¼·ã«ãªã‚Šã¾ã—ãŸï¼</p>
<p>æœ€å¾Œã«ä»Šå¾Œã‚„ã‚ŠãŸã„ã“ã¨ã«ã¤ã„ã¦åˆ—æŒ™ã—ã¦ãŠãã¨&hellip;</p>
<ul>
<li>AWS SQS ã‚’ä½¿ã£ãŸéåŒæœŸå‡¦ç†ã®å®Ÿè£…</li>
<li>Celery ã‚’ä½¿ã£ãŸéåŒæœŸå‡¦ç†ã®å®Ÿè£…</li>
<li>Broker ã¨ã—ã¦ Redis ã‚’ç”¨ã„ãŸå®Ÿè£…</li>
<li>DB ã‚’ä½¿ã£ãŸãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜</li>
<li>etc&hellip;</li>
</ul>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://fastapi.tiangolo.com/" target="_blank">FastAPI</a></li>
<li><a href="https://www.rabbitmq.com/" target="_blank">RabbitMQ</a>
<ul>
<li><a href="https://www.rabbitmq.com/getstarted.html" target="_blank">RabbitMQ Tutorials</a></li>
</ul>
</li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/architecture/microservices/architect-microservice-container-applications/asynchronous-message-based-communication" target="_blank">Asynchronous message-based communication</a></li>
<li><a href="https://medium.com/@si.allen/part-1-deep-learning-scaling-your-neural-networks-with-containerization-and-a-message-broker-d9c872a8345b" target="_blank">Deep Learning: Scaling your neural networks with containerization and a message broker</a></li>
<li><a href="https://github.com/katanaml/katana-skipper" target="_blank">katanaml/katana-skipper</a></li>
</ul>

        <hr>
        

  <h3>ã“ã®è¨˜äº‹ã¨é–¢é€£ã™ã‚‹è¨˜äº‹ã‚’èª­ã‚“ã§ã¿ã‚‹</h3>
  <ul>
    
      <li><a href="/portfolio/post/annoy-lib-illegal-instruction-error/">ANN ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã® Annoy ã§ build index ã™ã‚‹æ™‚ã« Illegal Instruction Error ãŒç™ºç”Ÿã—ãŸ</a></li>
    
      <li><a href="/portfolio/post/customize-tf-callback/">Tensorflow ã® Callback é–¢æ•°ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</a></li>
    
      <li><a href="/portfolio/post/cuda-error-device-side-assert-triggered/">RuntimeError: CUDA error: Device-side assert triggered ã®è§£æ±ºæ–¹æ³•</a></li>
    
      <li><a href="/portfolio/post/how-to-recreate-ml-pipeline/">æ©Ÿæ¢°å­¦ç¿’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ä½œã‚Šæ–¹ã‚’æ”¹ã‚ã¦è€ƒãˆã¦ã¿ã‚‹</a></li>
    
      <li><a href="/portfolio/post/service-account-for-vertex-ai-pipelines/">Vertex AI Pipelines ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§å°‘ã—ã¤ã¾ãšã„ãŸã®ã§æ•´ç†ã—ãŸ</a></li>
    
  </ul>

        <div id="share-buttons">
            

<style>
    #share-buttons {display: inline-block; vertical-align: middle; }
    #share-buttons > div {
        position: relative;
        text-align: left;
         
        float: left;
        margin-top: 10.25mm
    }
</style>


<div id="share-buttons">
    <a href="https://twitter.com/share" class="twitter-share-button">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="ã“ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’ã¯ã¦ãªãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«è¿½åŠ "><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="ã“ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’ã¯ã¦ãªãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«è¿½åŠ " width="20" height="20" style="border: none;" /></a>
    <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
</div>

        </div>
    </div>
    
    <div class="post-content markdown-body">
        <h2>Support</h2>
        <p>ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’èª­ã‚“ã§é ‚ãï¼Œã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã‚‚ã—ã“ã®è¨˜äº‹ãŒè‰¯ã‹ã£ãŸã‚Šå‚è€ƒã«ãªã£ãŸã‚‰ï¼Œä¸‹è¨˜ãƒœã‚¿ãƒ³ã‹ã‚‰&#x2615;ä¸€æ¯ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦é ‚ã‘ã‚‹ã¨ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸ŠãŒã‚Šã¾ã™ï¼ã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™&#x1f929;</p>
        <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="asteriam" data-color="#FFDD00" data-emoji=""  data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#000000" data-coffee-color="#ffffff" ></script>
    </div>
    
</article>




            </div>
            <aside class="col-12 col-md-3 float-left sidebar">
    
    <div class="sidebar-item sidebar-pages">
        <h3>Pages</h3>
        <ul>
            
            <li>
                <a href="/portfolio/">Home</a>
            </li>
            
            <li>
                <a href="/portfolio/about/">About</a>
            </li>
            
            <li>
                <a href="/portfolio/activity/">Activity</a>
            </li>
            
            <li>
                <a href="/portfolio/archives/">Posts</a>
            </li>
            
            <li>
                <a href="/portfolio/search/">Search</a>
            </li>
            
            <li>
                <a href="/portfolio/index.xml">RSS</a>
            </li>
            
        </ul>
    </div>
    
    
    
    <div class="sidebar-item sidebar-tags">
        <h3>Tags</h3>
        <div>
            
            <span>
                <a href="/portfolio/tags/aws/">AWS</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/data/">DATA</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/dev/">DEV</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/ds/">DS</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/gcp/">GCP</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/kaggle/">KAGGLE</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/ml/">ML</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/mlops/">MLOPS</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/poem/">POEM</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/recsys/">RECSYS</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/stats/">STATS</a>
            </span>
            
        </div>
    </div>
    
    
    
    <div class="sidebar-item sidebar-toc">
        <h3>TOC</h3>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#ã¯ã˜ã‚ã«">ã¯ã˜ã‚ã«</a></li>
    <li><a href="#message-queuing-serviceã¨ã¯">Message Queuing Serviceã¨ã¯ï¼Ÿ</a>
      <ul>
        <li><a href="#rabbitmqã‚’ä½¿ã£ãŸå®Ÿè£…">RabbitMQã‚’ä½¿ã£ãŸå®Ÿè£…</a></li>
      </ul>
    </li>
    <li><a href="#ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ">ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ</a></li>
    <li><a href="#producerã®å®Ÿè£…">Producerã®å®Ÿè£…</a></li>
    <li><a href="#consumer-ã®å®Ÿè£…">Consumer ã®å®Ÿè£…</a></li>
    <li><a href="#å®Ÿè¡Œçµæœ">å®Ÿè¡Œçµæœ</a>
      <ul>
        <li><a href="#å­¦ç¿’ç·¨">å­¦ç¿’ç·¨</a></li>
        <li><a href="#äºˆæ¸¬ç·¨">äºˆæ¸¬ç·¨</a></li>
      </ul>
    </li>
    <li><a href="#ãŠã‚ã‚Šã«">ãŠã‚ã‚Šã«</a></li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>
    </div>
    
    
</aside>
        </div>
        <div class="btn">
    <div class="btn-menu" id="btn-menu">
        <i class="iconfont icon-grid-sharp"></i>
    </div>
    <div class="btn-toggle-mode">
        <i class="iconfont icon-contrast-sharp"></i>
    </div>
    <div class="btn-scroll-top">
        <i class="iconfont icon-chevron-up-circle-sharp"></i>
    </div>
</div>
<aside class="sidebar-mobile" style="display: none;">
  <div class="sidebar-wrapper">
    
    <div class="sidebar-item sidebar-pages">
        <h3>Pages</h3>
        <ul>
            
            <li>
                <a href="/portfolio/">Home</a>
            </li>
            
            <li>
                <a href="/portfolio/about/">About</a>
            </li>
            
            <li>
                <a href="/portfolio/activity/">Activity</a>
            </li>
            
            <li>
                <a href="/portfolio/archives/">Posts</a>
            </li>
            
            <li>
                <a href="/portfolio/search/">Search</a>
            </li>
            
            <li>
                <a href="/portfolio/index.xml">RSS</a>
            </li>
            
        </ul>
    </div>
    
    
    
    <div class="sidebar-item sidebar-tags">
        <h3>Tags</h3>
        <div>
            
            <span>
                <a href="/portfolio/tags/aws/">AWS</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/data/">DATA</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/dev/">DEV</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/ds/">DS</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/gcp/">GCP</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/kaggle/">KAGGLE</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/ml/">ML</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/mlops/">MLOPS</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/poem/">POEM</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/recsys/">RECSYS</a>
            </span>
            
            <span>
                <a href="/portfolio/tags/stats/">STATS</a>
            </span>
            
        </div>
    </div>
    
    
    
    <div class="sidebar-item sidebar-toc">
        <h3>TOC</h3>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#ã¯ã˜ã‚ã«">ã¯ã˜ã‚ã«</a></li>
    <li><a href="#message-queuing-serviceã¨ã¯">Message Queuing Serviceã¨ã¯ï¼Ÿ</a>
      <ul>
        <li><a href="#rabbitmqã‚’ä½¿ã£ãŸå®Ÿè£…">RabbitMQã‚’ä½¿ã£ãŸå®Ÿè£…</a></li>
      </ul>
    </li>
    <li><a href="#ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ">ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ</a></li>
    <li><a href="#producerã®å®Ÿè£…">Producerã®å®Ÿè£…</a></li>
    <li><a href="#consumer-ã®å®Ÿè£…">Consumer ã®å®Ÿè£…</a></li>
    <li><a href="#å®Ÿè¡Œçµæœ">å®Ÿè¡Œçµæœ</a>
      <ul>
        <li><a href="#å­¦ç¿’ç·¨">å­¦ç¿’ç·¨</a></li>
        <li><a href="#äºˆæ¸¬ç·¨">äºˆæ¸¬ç·¨</a></li>
      </ul>
    </li>
    <li><a href="#ãŠã‚ã‚Šã«">ãŠã‚ã‚Šã«</a></li>
    <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
  </ul>
</nav>
    </div>
    
    
  </div>
</aside>
    </main>

    <footer>
    <div class="container-lg clearfix">
        <div class="col-12 footer">
            
            <span>&copy; 2019-2023
                <a href="https://masatakashiwagi.github.io/portfolio/">Masataka Kashiwagi</a>
                 | <a href="https://github.com/masatakashiwagi/portfolio/">Source code</a> 
                | Powered by <a href="https://github.com/amzrk2/hugo-theme-fuji/"
                   target="_blank">Fuji-v2</a> &amp; <a href="https://gohugo.io/"
                                                    target="_blank">Hugo</a> 
            </span>
        </div>
    </div>
</footer>

    
<script defer src="https://cdn.jsdelivr.net/combine/npm/medium-zoom@1.0.6,npm/lazysizes@5.2.2"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.21.0/components/prism-core.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.21.0/plugins/autoloader/prism-autoloader.min.js"></script>



<script defer src="/portfolio/assets/js/fuji.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" />
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"></script>
<script
  defer
  src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
  onload="renderMathInElement(document.body);"
></script>



</body>

</html>